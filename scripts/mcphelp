#!/bin/bash
# Pablo's Interactive MCP Help & Management System
# Following the pattern of the existing cheat system

# Check if we're in an interactive environment
check_interactive() {
    if [[ ! -t 0 || ! -t 1 ]]; then
        return 1  # Not interactive
    fi
    if ! command -v gum >/dev/null 2>&1; then
        return 1  # gum not available
    fi
    # Test if gum can actually work
    if ! gum --help >/dev/null 2>&1; then
        return 1  # gum not functional
    fi
    return 0  # Interactive and gum works
}

# Colors
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
PURPLE='\033[0;35m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Track if user is new to MCP help
FIRST_RUN_FILE="$HOME/.mcphelp_welcomed"
CONFIG_DIR="$HOME/.terminal-power"
STATUS_FILE="$CONFIG_DIR/status.json"

# Ensure config directory exists
mkdir -p "$CONFIG_DIR"

# Smart setup detection
detect_setup_status() {
    local setup_score=0
    local max_score=10
    
    # Check core components (2 points each)
    [[ -f ~/voice-to-claude.sh ]] && ((setup_score += 2))
    [[ -f ~/github-search.sh ]] && ((setup_score += 2))
    [[ -x ~/bin/mcphelp ]] && ((setup_score += 1))
    
    # Check API keys (1 point each)
    [[ -n "$OPENAI_API_KEY" ]] && ((setup_score += 1))
    [[ -n "$GITHUB_TOKEN" ]] && ((setup_score += 1))
    [[ -n "$SUPABASE_ACCESS_TOKEN" ]] && ((setup_score += 1))
    [[ -n "$GOOGLE_API_KEY" ]] && ((setup_score += 1))
    
    # Check Claude Code (1 point)
    command -v claude >/dev/null 2>&1 && ((setup_score += 1))
    
    # Calculate setup percentage
    SETUP_PERCENTAGE=$((setup_score * 100 / max_score))
    
    # Determine setup status
    if [[ $setup_score -ge 8 ]]; then
        SETUP_STATUS="complete"
    elif [[ $setup_score -ge 5 ]]; then
        SETUP_STATUS="partial"
    else
        SETUP_STATUS="needs_setup"
    fi
}

# Auto-fix common issues
auto_fix_issues() {
    local fixes_applied=()
    
    # Fix executable permissions
    if [[ -f ~/voice-to-claude.sh && ! -x ~/voice-to-claude.sh ]]; then
        chmod +x ~/voice-to-claude.sh && fixes_applied+=("Made voice script executable")
    fi
    
    if [[ -f ~/github-search.sh && ! -x ~/github-search.sh ]]; then
        chmod +x ~/github-search.sh && fixes_applied+=("Made GitHub search script executable")
    fi
    
    if [[ -f ~/bin/mcphelp && ! -x ~/bin/mcphelp ]]; then
        chmod +x ~/bin/mcphelp && fixes_applied+=("Made MCP help script executable")
    fi
    
    # Create bin directory if missing
    if [[ ! -d ~/bin ]]; then
        mkdir -p ~/bin && fixes_applied+=("Created ~/bin directory")
    fi
    
    # Report fixes
    if [[ ${#fixes_applied[@]} -gt 0 ]]; then
        echo -e "${GREEN}üîß Auto-fixed issues:${NC}"
        printf '  ‚úÖ %s\n' "${fixes_applied[@]}"
        echo ""
    fi
}

# Fallback menu for non-interactive environments
show_fallback_menu() {
    echo "ü§ñ MCP HELP - CYBERPUNK AI TERMINAL"
    echo "=================================="
    echo ""
    echo "Available commands:"
    echo "  mcphelp            - Show this menu"
    echo "  mcphelp quick      - Quick start guide"
    echo "  mcphelp api        - API key setup"
    echo "  mcphelp mcp        - MCP management"
    echo "  mcphelp test       - Test your setup"
    echo "  mcphelp voice      - Voice commands guide"
    echo "  mcphelp github     - GitHub search help"
    echo "  mcphelp troubleshoot - Fix common issues"
    echo ""
    echo "For full interactive experience:"
    echo "  1. Install gum: brew install gum"
    echo "  2. Run from a proper terminal (not IDE)"
    echo "  3. Ensure TTY is available"
}

# Enhanced welcome screen with smart onboarding
show_welcome() {
    # Run setup detection and auto-fixes
    detect_setup_status
    auto_fix_issues
    
    if [ ! -f "$FIRST_RUN_FILE" ]; then
        if ! check_interactive; then
            show_fallback_menu
            return
        fi
        
        clear
        echo -e "${CYAN}"
        if command -v figlet >/dev/null && command -v lolcat >/dev/null; then
            figlet "Terminal Power" | lolcat
        else
            echo "ü§ñ TERMINAL POWER - AI COMMAND CENTER ü§ñ"
        fi
        echo -e "${NC}"
        
        # Show personalized welcome based on setup status
        case "$SETUP_STATUS" in
            "complete")
                gum style \
                    --border double \
                    --border-foreground 87 \
                    --padding "1 2" \
                    --margin "1" \
                    --align center \
                    "üéâ WELCOME BACK, CYBERPUNK WIZARD! üéâ

Setup Status: ${SETUP_PERCENTAGE}% Complete ‚úÖ

Your AI terminal is ready to rock:
‚Ä¢ Voice commands are configured
‚Ä¢ MCPs are loaded and ready
‚Ä¢ APIs are connected
‚Ä¢ All systems operational

Ready to create some magic?"
                ;;
            "partial")
                gum style \
                    --border double \
                    --border-foreground 214 \
                    --padding "1 2" \
                    --margin "1" \
                    --align center \
                    "üöÄ WELCOME TO TERMINAL POWER! üöÄ

Setup Status: ${SETUP_PERCENTAGE}% Complete ‚ö†Ô∏è

You're halfway to AI mastery!
We detected some missing components.
Let's get you fully powered up.

Ready to complete the setup?"
                ;;
            "needs_setup")
                gum style \
                    --border double \
                    --border-foreground 208 \
                    --padding "1 2" \
                    --margin "1" \
                    --align center \
                    "üéØ WELCOME TO TERMINAL POWER! üéØ

Setup Status: ${SETUP_PERCENTAGE}% Complete üîß

Looks like you're just getting started!
No worries - I'll guide you through everything.
In 5 minutes you'll have AI superpowers.

Ready to transform your terminal?"
                ;;
        esac
        
        echo ""
        if [[ "$SETUP_STATUS" == "complete" ]]; then
            echo -e "${GREEN}üí° Next: Choose 'Quick Start Guide' to see what you can do!${NC}"
            echo ""
            if confirm "Open the Terminal Power control center?"; then
                # Continue to main menu
                true
            else
                return
            fi
        else
            echo -e "${BLUE}üí° I'll open an interactive menu with easy setup options.${NC}"
            echo ""
            if confirm "Let's set up your missing components?"; then
                show_guided_setup
                return
            else
                if confirm "Skip setup and explore what works now?"; then
                    show_quick_tour
                    return
                fi
            fi
        fi
        touch "$FIRST_RUN_FILE"
    fi
}

# Guided setup for incomplete installations
show_guided_setup() {
    clear
    gum style \
        --border rounded \
        --border-foreground 99 \
        --padding "1 2" \
        "üõ†Ô∏è GUIDED SETUP - LET'S GET YOU POWERED UP!

I'll check what's missing and help you fix it.
This will take just a few minutes.

Don't worry - I'll explain everything as we go!"
    
    echo ""
    confirm "Ready to start?" || return
    
    # Guide through each missing component
    if [[ ! -f ~/voice-to-claude.sh ]]; then
        show_voice_setup_guide
    fi
    
    if [[ -z "$OPENAI_API_KEY" ]]; then
        show_api_setup_guide
    fi
    
    if ! command -v claude >/dev/null 2>&1; then
        show_claude_setup_guide
    fi
    
    # Recheck status
    detect_setup_status
    
    if [[ "$SETUP_STATUS" == "complete" ]]; then
        gum style \
            --border double \
            --border-foreground 87 \
            --padding "1 2" \
            --align center \
            "üéâ SETUP COMPLETE! WELCOME TO THE FUTURE! üéâ

Your terminal is now a cyberpunk AI command center!
Everything is configured and ready to use.

Time to create some magic! ‚ú®"
    else
        gum style \
            --border rounded \
            --border-foreground 214 \
            --padding "1 2" \
            "üöÄ GREAT PROGRESS! ${SETUP_PERCENTAGE}% COMPLETE

You're almost there! A few more steps and 
you'll have full AI superpowers.

Use 'mcp test' to see what's still needed."
    fi
}

# Quick tour for new users
show_quick_tour() {
    clear
    gum style \
        --border rounded \
        --border-foreground 99 \
        --padding "1 2" \
        "üöÄ QUICK TOUR - YOUR AI SUPERPOWERS

1. üéôÔ∏è Voice Commands ‚Üí Speak to control your terminal
   Try: voice \"show me my supabase projects\"

2. üîç GitHub Discovery ‚Üí Find any code instantly
   Try: ghsearch \"deno auth\" repositories

3. üé® AI Image Generation ‚Üí Create wallpapers & graphics
   Try: \"Generate a cyberpunk wallpaper using DALL-E\"

4. üóÑÔ∏è Database Operations ‚Üí Natural language SQL
   Try: \"Show me all tables in my database\"

5. üìß Email Automation ‚Üí AI-powered email management
   Try: \"Find emails about business opportunities\"

üéØ TIP: Type 'mcp' anytime to return to this control center!"
    
    echo ""
    gum input --placeholder "Press enter to continue to main menu..."
}

# Main menu function
show_main_menu() {
    # Handle command line arguments for fallback mode
    if [[ $# -gt 0 ]]; then
        case "$1" in
            "help"|"--help"|"")
                show_fallback_menu
                return
                ;;
            "quick")
                show_quick_start_text
                return
                ;;
            "api")
                show_api_setup_text
                return
                ;;
            "mcp")
                show_mcp_management_text
                return
                ;;
            "test")
                test_setup_text
                return
                ;;
            "voice")
                show_voice_guide_text
                return
                ;;
            "github")
                show_github_guide_text
                return
                ;;
            "troubleshoot")
                show_troubleshooting_text
                return
                ;;
        esac
    fi
    
    if ! check_interactive; then
        show_fallback_menu
        return
    fi
    
    clear
    echo -e "${CYAN}"
    if command -v figlet >/dev/null && command -v lolcat >/dev/null; then
        figlet "MCP Control" | lolcat
    else
        echo "ü§ñ MCP CYBERPUNK TERMINAL ü§ñ"
    fi
    echo -e "${NC}"
    
    # Show quick status
    show_quick_status
    
    echo ""
    CHOICE=$(gum choose \
        "üöÄ Quick Start Guide" \
        "üîß MCP Management (Add/Remove/List)" \
        "üé® API Packs (Creative/Dev/Fun Extensions)" \
        "üîë API Key Setup & Management" \
        "üß™ Test Your Setup" \
        "üéôÔ∏è Voice Commands Guide" \
        "üîç GitHub Search Help" \
        "üìö MCP Arsenal Overview (Your 16 MCPs)" \
        "üé® Creative Workflows & Examples" \
        "üö® Troubleshooting & Diagnostics" \
        "‚≠ê What's New & Updates" \
        "üåà Show Me Something Cool" \
        "‚ùå Exit")
    
    case "$CHOICE" in
        "üöÄ Quick Start Guide")
            show_quick_start
            ;;
        "üîß MCP Management (Add/Remove/List)")
            show_mcp_management
            ;;
        "üé® API Packs (Creative/Dev/Fun Extensions)")
            show_pack_management
            ;;
        "üîë API Key Setup & Management")
            show_api_setup
            ;;
        "üß™ Test Your Setup")
            test_setup
            ;;
        "üéôÔ∏è Voice Commands Guide")
            show_voice_guide
            ;;
        "üîç GitHub Search Help")
            show_github_guide
            ;;
        "üìö MCP Arsenal Overview (Your 16 MCPs)")
            show_mcp_arsenal
            ;;
        "üé® Creative Workflows & Examples")
            show_creative_workflows
            ;;
        "üö® Troubleshooting & Diagnostics")
            show_troubleshooting
            ;;
        "‚≠ê What's New & Updates")
            show_whats_new
            ;;
        "üåà Show Me Something Cool")
            show_something_cool
            ;;
        "‚ùå Exit")
            echo ""
            if command -v cowsay >/dev/null && command -v lolcat >/dev/null; then
                echo "Keep building the future with AI! ü§ñ‚ö°" | cowsay | lolcat
            else
                echo "ü§ñ Keep building the future with AI! ‚ö°"
            fi
            echo ""
            echo "üí° TIP: Type 'mcp' anytime to return!"
            exit 0
            ;;
    esac
    
    echo ""
    gum confirm "Back to main menu?" && show_main_menu
}

# Quick status overview
show_quick_status() {
    local voice_status="‚ùå"
    local github_status="‚ùå"
    local supabase_status="‚ùå"
    local mcp_count=0
    
    # Check API keys
    [[ -n "$OPENAI_API_KEY" ]] && voice_status="‚úÖ"
    [[ -n "$GITHUB_TOKEN" ]] && github_status="‚úÖ"
    [[ -n "$SUPABASE_ACCESS_TOKEN" ]] && supabase_status="‚úÖ"
    
    # Count MCPs (if claude command exists)
    if command -v claude >/dev/null 2>&1; then
        mcp_count=$(claude mcp list 2>/dev/null | wc -l | tr -d ' ' || echo "0")
    fi
    
    gum style \
        --border rounded \
        --border-foreground 87 \
        --padding "0 1" \
        "üìä QUICK STATUS: Voice $voice_status | GitHub $github_status | Supabase $supabase_status | MCPs: $mcp_count"
}

# Quick Start Guide
show_quick_start() {
    clear
    gum style \
        --border double \
        --border-foreground 212 \
        --padding "1 2" \
        --margin "1" \
        "üöÄ QUICK START - GET YOUR AI TERMINAL RUNNING

STEP 1: Check Your Setup
Run: mcp test
This shows what's working and what needs setup.

STEP 2: Set Up API Keys (Critical!)
Run: mcp api
Add your OpenAI, GitHub, Google, and Supabase keys.

STEP 3: Verify MCPs Are Active
Run: mcp mcp
List and test your 16 AI-powered MCPs.

STEP 4: Test Voice Commands
Run: voice
Try: \"show me my supabase projects\"

STEP 5: Try GitHub Discovery
Run: ghsearch \"deno fresh auth\" repositories
Find any code you need instantly!

üéØ FIRST COMMANDS TO TRY:
‚Ä¢ voice ‚Üí \"generate a desktop wallpaper\"
‚Ä¢ voice ‚Üí \"find github examples of authentication\"
‚Ä¢ voice ‚Üí \"show me my recent emails\"
‚Ä¢ voice ‚Üí \"create a new deno project\"

üö® CRITICAL: Restart Claude Code after adding MCPs!"
    
    echo ""
    if gum confirm "Run the setup test now?"; then
        test_setup
    fi
}

# API Setup and Management
show_api_setup() {
    clear
    echo -e "${CYAN}"
    if command -v figlet >/dev/null; then
        echo "API Setup" | figlet -f small | lolcat
    else
        echo "üîë API KEY SETUP & MANAGEMENT"
    fi
    echo -e "${NC}"
    
    # Show current API status
    show_api_status_dashboard
    
    echo ""
    API_CHOICE=$(gum choose \
        "üìã Show API Status Dashboard" \
        "‚ûï Add New API Key" \
        "üß™ Test API Connections" \
        "üìã Copy Environment Variables" \
        "üí∞ Show API Costs & Limits" \
        "üîó Get API Key Links" \
        "üö® Priority APIs (Get These First)" \
        "üîô Back to main menu")
    
    case "$API_CHOICE" in
        "üìã Show API Status Dashboard")
            show_detailed_api_status
            ;;
        "‚ûï Add New API Key")
            add_api_key_wizard
            ;;
        "üß™ Test API Connections")
            test_api_connections
            ;;
        "üìã Copy Environment Variables")
            generate_env_vars
            ;;
        "üí∞ Show API Costs & Limits")
            show_api_costs
            ;;
        "üîó Get API Key Links")
            show_api_links
            ;;
        "üö® Priority APIs (Get These First)")
            show_priority_apis
            ;;
        "üîô Back to main menu")
            return
            ;;
    esac
    
    echo ""
    gum confirm "Continue with API setup?" && show_api_setup
}

# Show API status dashboard
show_api_status_dashboard() {
    local status_text=""
    
    # Check each API
    if [[ -n "$OPENAI_API_KEY" ]]; then
        status_text+="üéôÔ∏è Voice & AI:       ‚úÖ OpenAI API Ready\\n"
    else
        status_text+="üéôÔ∏è Voice & AI:       ‚ùå Need OpenAI API Key\\n"
    fi
    
    if [[ -n "$GITHUB_TOKEN" ]]; then
        status_text+="üîç GitHub Search:    ‚úÖ GitHub Token Ready\\n"
    else
        status_text+="üîç GitHub Search:    ‚ùå Need GitHub Token\\n"
    fi
    
    if [[ -n "$SUPABASE_ACCESS_TOKEN" ]]; then
        status_text+="üóÑÔ∏è Database Ops:     ‚úÖ Supabase Ready\\n"
    else
        status_text+="üóÑÔ∏è Database Ops:     ‚ùå Need Supabase Token\\n"
    fi
    
    if [[ -n "$GOOGLE_API_KEY" ]]; then
        status_text+="üìß Gmail/Calendar:   ‚úÖ Google API Ready\\n"
    else
        status_text+="üìß Gmail/Calendar:   ‚ùå Need Google API Key\\n"
    fi
    
    if [[ -n "$REPLICATE_API_TOKEN" ]]; then
        status_text+="üé® Advanced AI:      ‚úÖ Replicate Ready\\n"
    else
        status_text+="üé® Advanced AI:      ‚ö†Ô∏è  Optional: Replicate API\\n"
    fi
    
    if [[ -n "$RAILWAY_TOKEN" ]]; then
        status_text+="üöÄ Deployments:      ‚úÖ Railway Ready\\n"
    else
        status_text+="üöÄ Deployments:      ‚ö†Ô∏è  Optional: Railway Token\\n"
    fi
    
    if [[ -n "$ELEVENLABS_API_KEY" ]]; then
        status_text+="üéµ Voice Generation: ‚úÖ ElevenLabs Ready\\n"
    else
        status_text+="üéµ Voice Generation: ‚ö†Ô∏è  Optional: ElevenLabs API\\n"
    fi
    
    if [[ -n "$STEAM_API_KEY" ]]; then
        status_text+="üéÆ Gaming:           ‚úÖ Steam API Ready\\n"
    else
        status_text+="üéÆ Gaming:           ‚ö†Ô∏è  Optional: Steam API\\n"
    fi
    
    gum style \
        --border double \
        --border-foreground 87 \
        --padding "1 2" \
        "üìä API STATUS DASHBOARD\\n$status_text"
}

# MCP Management
show_mcp_management() {
    clear
    echo -e "${CYAN}"
    if command -v figlet >/dev/null; then
        echo "MCP Control" | figlet -f small | lolcat
    else
        echo "üîß MCP MANAGEMENT"
    fi
    echo -e "${NC}"
    
    # Show MCP status
    show_mcp_status
    
    echo ""
    MCP_CHOICE=$(gum choose \
        "üìã List Active MCPs" \
        "‚ûï Add New MCP" \
        "‚ùå Remove MCP" \
        "üß™ Test Individual MCP" \
        "üîÑ Restart Claude Code" \
        "üö® Troubleshoot MCPs" \
        "üì¶ Install MCP Dependencies" \
        "üîô Back to main menu")
    
    case "$MCP_CHOICE" in
        "üìã List Active MCPs")
            list_active_mcps
            ;;
        "‚ûï Add New MCP")
            add_mcp_wizard
            ;;
        "‚ùå Remove MCP")
            remove_mcp_wizard
            ;;
        "üß™ Test Individual MCP")
            test_individual_mcp
            ;;
        "üîÑ Restart Claude Code")
            restart_claude_code_guide
            ;;
        "üö® Troubleshoot MCPs")
            troubleshoot_mcps
            ;;
        "üì¶ Install MCP Dependencies")
            install_mcp_dependencies
            ;;
        "üîô Back to main menu")
            return
            ;;
    esac
    
    echo ""
    gum confirm "Continue with MCP management?" && show_mcp_management
}

# Show MCP status
show_mcp_status() {
    if command -v claude >/dev/null 2>&1; then
        local mcp_count=$(claude mcp list 2>/dev/null | wc -l | tr -d ' ' || echo "0")
        local status_color="87"
        local status_text="‚úÖ Claude Code Found"
        
        if [[ "$mcp_count" -eq 0 ]]; then
            status_color="208"
            status_text="‚ö†Ô∏è  No MCPs Configured"
        elif [[ "$mcp_count" -lt 16 ]]; then
            status_color="214"
            status_text="‚ö†Ô∏è  $mcp_count/16 MCPs Active"
        else
            status_text="‚úÖ $mcp_count MCPs Active"
        fi
        
        gum style \
            --border rounded \
            --border-foreground "$status_color" \
            --padding "0 1" \
            "ü§ñ MCP STATUS: $status_text"
    else
        gum style \
            --border rounded \
            --border-foreground 208 \
            --padding "0 1" \
            "‚ùå Claude Code not found - install from https://docs.anthropic.com/claude-code"
    fi
}

# Pack Management
show_pack_management() {
    clear
    echo -e "${CYAN}"
    if command -v figlet >/dev/null; then
        echo "API Packs" | figlet -f small | lolcat
    else
        echo "üé® API PACK MANAGEMENT"
    fi
    echo -e "${NC}"
    
    # Use the pack manager script
    ~/Terminal_Power/scripts/pack-manager.sh packs
    
    echo ""
    PACK_CHOICE=$(gum choose \
        "üé® Install Creative Pack (Photos/Colors/Weather)" \
        "üìä Show Pack Status" \
        "üß™ Test Installed Packs" \
        "üìö Learn About Packs" \
        "üîô Back to Main Menu")
    
    case "$PACK_CHOICE" in
        "üé® Install Creative Pack (Photos/Colors/Weather)")
            echo ""
            gum style \
                --border rounded \
                --border-foreground 99 \
                --padding "1 2" \
                "üé® CREATIVE PACK INSTALLATION
                
This pack adds visual and design APIs to Terminal Power:
üì∏ Unsplash photos, üåà color tools, üå§Ô∏è weather
üì± QR codes, üé≠ fake data, üí¨ quotes

Some APIs need free keys (we'll help you get them)."
            
            echo ""
            if confirm "Install Creative Pack?"; then
                ~/Terminal_Power/scripts/pack-manager.sh install creative
                echo ""
                confirm "Press Enter to continue..."
            fi
            show_pack_management
            ;;
        "üìä Show Pack Status")
            ~/Terminal_Power/scripts/pack-manager.sh status
            echo ""
            confirm "Press Enter to continue..."
            show_pack_management
            ;;
        "üß™ Test Installed Packs")
            ~/Terminal_Power/scripts/pack-manager.sh test creative
            echo ""
            confirm "Press Enter to continue..."
            show_pack_management
            ;;
        "üìö Learn About Packs")
            clear
            gum style \
                --border double \
                --border-foreground 87 \
                --padding "1 2" \
                "üé® ABOUT API PACKS

Terminal Power uses a modular system:

üèóÔ∏è CORE: Voice, GitHub, Domains, MCPs (16 AI tools)
üì¶ PACKS: Optional API extensions you can add

üé® CREATIVE PACK:
  - Unsplash photos for your apps
  - Color palette extraction from websites  
  - Weather data from anywhere
  - QR code generation
  - Fake test data generation
  - Design quotes and inspiration

üöÄ WHY PACKS?
  - Keep Terminal Power lightweight
  - Add only what you need
  - Easy setup with guided wizards
  - No API key required for core features

Each pack is optional and adds new voice commands!"
            
            echo ""
            confirm "Press Enter to continue..."
            show_pack_management
            ;;
        "üîô Back to Main Menu")
            return
            ;;
    esac
}

# Test setup
test_setup() {
    clear
    echo -e "${CYAN}"
    if command -v figlet >/dev/null; then
        echo "System Test" | figlet -f small | lolcat
    else
        echo "üß™ TESTING YOUR SETUP"
    fi
    echo -e "${NC}"
    
    echo "üß™ Testing Your Cyberpunk AI Terminal Setup..."
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    
    # Test essential tools
    echo -e "\\n${YELLOW}Essential Tools:${NC}"
    command -v claude >/dev/null && echo "‚úÖ Claude Code" || echo "‚ùå Claude Code (CRITICAL - install from anthropic.com)"
    command -v deno >/dev/null && echo "‚úÖ Deno $(deno --version | head -1 | cut -d' ' -f2)" || echo "‚ùå Deno"
    command -v git >/dev/null && echo "‚úÖ Git" || echo "‚ùå Git"
    command -v node >/dev/null && echo "‚úÖ Node.js $(node --version)" || echo "‚ùå Node.js"
    command -v python3 >/dev/null && echo "‚úÖ Python3" || echo "‚ùå Python3"
    
    # Test voice setup
    echo -e "\\n${YELLOW}Voice Commands:${NC}"
    command -v ffmpeg >/dev/null && echo "‚úÖ ffmpeg (audio recording)" || echo "‚ùå ffmpeg - install: brew install ffmpeg"
    command -v jq >/dev/null && echo "‚úÖ jq (JSON parsing)" || echo "‚ùå jq - install: brew install jq"
    [[ -f ~/voice-to-claude.sh ]] && echo "‚úÖ Voice script installed" || echo "‚ùå Voice script missing"
    [[ -n "$OPENAI_API_KEY" ]] && echo "‚úÖ OpenAI API key set" || echo "‚ùå OpenAI API key missing"
    
    # Test GitHub integration
    echo -e "\\n${YELLOW}GitHub Integration:${NC}"
    command -v gh >/dev/null && echo "‚úÖ GitHub CLI" || echo "‚ùå GitHub CLI - install: brew install gh"
    [[ -f ~/github-search.sh ]] && echo "‚úÖ GitHub search script" || echo "‚ùå GitHub search script missing"
    [[ -n "$GITHUB_TOKEN" ]] && echo "‚úÖ GitHub token set" || echo "‚ùå GitHub token missing"
    
    # Test MCPs
    echo -e "\\n${YELLOW}MCPs Status:${NC}"
    if command -v claude >/dev/null 2>&1; then
        local mcp_count=$(claude mcp list 2>/dev/null | wc -l | tr -d ' ' || echo "0")
        if [[ "$mcp_count" -gt 0 ]]; then
            echo "‚úÖ $mcp_count MCPs configured"
        else
            echo "‚ùå No MCPs configured - add with: claude mcp add <name> <command>"
        fi
    else
        echo "‚ùå Cannot test MCPs - Claude Code not found"
    fi
    
    # Test API keys
    echo -e "\\n${YELLOW}API Keys:${NC}"
    [[ -n "$OPENAI_API_KEY" ]] && echo "‚úÖ OpenAI (voice + AI)" || echo "‚ùå OpenAI API key missing"
    [[ -n "$GOOGLE_API_KEY" ]] && echo "‚úÖ Google (Gmail/Calendar)" || echo "‚ùå Google API key missing"
    [[ -n "$GITHUB_TOKEN" ]] && echo "‚úÖ GitHub (code search)" || echo "‚ùå GitHub token missing"
    [[ -n "$SUPABASE_ACCESS_TOKEN" ]] && echo "‚úÖ Supabase (database)" || echo "‚ùå Supabase token missing"
    [[ -n "$REPLICATE_API_TOKEN" ]] && echo "‚úÖ Replicate (advanced AI)" || echo "‚ö†Ô∏è  Replicate API (optional)"
    [[ -n "$RAILWAY_TOKEN" ]] && echo "‚úÖ Railway (deployment)" || echo "‚ö†Ô∏è  Railway token (optional)"
    
    echo -e "\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    
    # Overall assessment
    local critical_missing=0
    command -v claude >/dev/null || ((critical_missing++))
    [[ -n "$OPENAI_API_KEY" ]] || ((critical_missing++))
    [[ -f ~/voice-to-claude.sh ]] || ((critical_missing++))
    
    if [[ $critical_missing -eq 0 ]]; then
        echo -e "${GREEN}üéâ EXCELLENT! Your cyberpunk terminal is ready!${NC}"
        echo ""
        echo "üöÄ Try these commands:"
        echo "  voice ‚Üí \"show me my supabase projects\""
        echo "  ghsearch \"deno auth\" repositories"
        echo "  mcp ‚Üí for this control center"
    elif [[ $critical_missing -le 2 ]]; then
        echo -e "${YELLOW}‚ö†Ô∏è  ALMOST READY! Fix the ‚ùå items above.${NC}"
        echo ""
        echo "üîß Quick fixes:"
        echo "  ‚Ä¢ Add missing API keys: mcp api"
        echo "  ‚Ä¢ Install missing tools with brew"
    else
        echo -e "${RED}üö® NEEDS SETUP! Several critical items missing.${NC}"
        echo ""
        echo "üìö Follow the setup guide: mcp quick"
    fi
    
    echo ""
    gum input --placeholder "Press enter to continue..."
}

# Text versions for fallback mode
show_quick_start_text() {
    echo "üöÄ QUICK START GUIDE"
    echo "==================="
    echo ""
    echo "1. Check setup: mcphelp test"
    echo "2. Add API keys: mcphelp api"  
    echo "3. Configure MCPs: mcphelp mcp"
    echo "4. Test voice: voice"
    echo "5. Test GitHub: ghsearch \"deno\" repositories"
}

show_api_setup_text() {
    echo "üîë API KEY SETUP"
    echo "==============="
    echo ""
    echo "Required APIs:"
    echo "  OpenAI    ‚Üí https://platform.openai.com/account/api-keys"
    echo "  GitHub    ‚Üí https://github.com/settings/tokens"
    echo "  Google    ‚Üí https://console.cloud.google.com/apis/credentials"
    echo "  Supabase  ‚Üí https://supabase.com/dashboard/account/tokens"
    echo ""
    echo "Add to ~/.zshrc:"
    echo "  export OPENAI_API_KEY=\"your-key\""
    echo "  export GITHUB_TOKEN=\"your-token\""
    echo "  etc..."
}

show_mcp_management_text() {
    echo "üîß MCP MANAGEMENT"
    echo "================"
    echo ""
    echo "List MCPs:    claude mcp list"
    echo "Add MCP:      claude mcp add <name> <command>"
    echo "Remove MCP:   claude mcp remove <name>"
    echo ""
    echo "After changes: Restart Claude Code"
}

test_setup_text() {
    echo "üß™ TESTING SETUP"
    echo "==============="
    echo ""
    echo "Run: mcphelp test"
    echo "This will check all components and show what needs fixing."
}

show_voice_guide_text() {
    echo "üéôÔ∏è VOICE COMMANDS"
    echo "================"
    echo ""
    echo "Basic usage:"
    echo "  voice     ‚Üí Record 5 seconds"
    echo "  voice10   ‚Üí Record 10 seconds"
    echo ""
    echo "Example commands:"
    echo "  \"show me my supabase projects\""
    echo "  \"find github examples of deno auth\""
    echo "  \"generate a desktop wallpaper\""
}

show_github_guide_text() {
    echo "üîç GITHUB SEARCH"
    echo "==============="
    echo ""
    echo "Basic usage:"
    echo "  ghsearch \"search term\" repositories"
    echo "  ghsearch \"code pattern\" code"
    echo ""
    echo "Examples:"
    echo "  ghsearch \"deno fresh auth\" repositories"
    echo "  ghsearch \"supabase middleware\" code"
}

show_troubleshooting_text() {
    echo "üö® TROUBLESHOOTING"
    echo "=================="
    echo ""
    echo "Common issues:"
    echo "  Voice not working ‚Üí Check OpenAI API key, install ffmpeg"
    echo "  MCPs not loading ‚Üí Restart Claude Code"
    echo "  GitHub search failing ‚Üí Set GitHub token"
    echo ""
    echo "Run: mcphelp test"
    echo "For detailed diagnostics"
}

# Placeholder functions for interactive features
show_detailed_api_status() {
    gum style \
        --border double \
        --border-foreground 87 \
        --padding "1 2" \
        "üîç DETAILED API STATUS

This will show:
‚Ä¢ Connection test results for each API
‚Ä¢ Usage limits and costs
‚Ä¢ Setup instructions for missing APIs
‚Ä¢ Troubleshooting for failed connections

[Feature coming in next update]"
    gum input --placeholder "Press enter to continue..."
}

add_api_key_wizard() {
    gum style \
        --border double \
        --border-foreground 212 \
        --padding "1 2" \
        "üßô‚Äç‚ôÇÔ∏è API KEY SETUP WIZARD

This interactive wizard will guide you through:
‚Ä¢ Getting API keys from each service
‚Ä¢ Testing the connections
‚Ä¢ Adding them to your shell configuration
‚Ä¢ Verifying everything works

[Feature coming in next update]"
    gum input --placeholder "Press enter to continue..."
}

list_active_mcps() {
    if command -v claude >/dev/null 2>&1; then
        echo "üìã Currently Active MCPs:"
        echo "========================"
        claude mcp list 2>/dev/null || echo "No MCPs found or Claude Code not responding"
    else
        echo "‚ùå Claude Code not found. Install from https://docs.anthropic.com/claude-code"
    fi
    echo ""
    gum input --placeholder "Press enter to continue..."
}

show_mcp_arsenal() {
    gum style \
        --border double \
        --border-foreground 99 \
        --padding "1 2" \
        "üìö YOUR 16 MCP ARSENAL

üé® Creative & AI (4 MCPs):
‚Ä¢ outsource - Multi-AI access (DALL-E, GPT-4, Claude)
‚Ä¢ huggingface - 300k+ free AI models
‚Ä¢ ableton-live - Music production control
‚Ä¢ sequential-thinking - Enhanced reasoning

üåê Data & Web (5 MCPs):
‚Ä¢ supabase - Database operations
‚Ä¢ gmail - Email automation (OAuth2)
‚Ä¢ calendar - Google Calendar integration
‚Ä¢ youtube-watchlater - YouTube playlist management
‚Ä¢ webscraper - Web data extraction

üîß System & Files (4 MCPs):
‚Ä¢ macos-automator - Mac system control
‚Ä¢ filesystem - Advanced file operations
‚Ä¢ wcgw - Autonomous shell execution
‚Ä¢ terminal-control - Enhanced terminal automation

üîó Integration & Tools (3 MCPs):
‚Ä¢ openapi - Universal API connector
‚Ä¢ markitdown-simple - Universal file converter
‚Ä¢ free-will - AI autonomy experiment

üí° Use these with voice commands for maximum power!"
    
    echo ""
    gum input --placeholder "Press enter to continue..."
}

show_creative_workflows() {
    WORKFLOW=$(gum choose \
        "üé¨ Content Creator Workflow" \
        "üéµ Music Producer Workflow" \
        "üë®‚Äçüíª Indie Developer Workflow" \
        "üßò Digital Minimalist Workflow" \
        "üé® Creative Freelancer Workflow" \
        "üîô Back")
    
    case "$WORKFLOW" in
        "üé¨ Content Creator Workflow")
            gum style \
                --border double \
                --border-foreground 205 \
                --padding "1 2" \
                "üé¨ CONTENT CREATOR WORKFLOW

1. Research & Planning:
   voice ‚Üí \"Research trending topics in web development\"
   ghsearch \"deno projects\" repositories

2. Asset Creation:
   voice ‚Üí \"Generate 5 thumbnail concepts using DALL-E\"
   voice ‚Üí \"Create background music using Ableton Live\"

3. Production:
   voice ‚Üí \"Write a video script about building a SaaS\"
   voice ‚Üí \"Take screenshots of my development process\"

4. Publishing:
   voice ‚Üí \"Upload to YouTube with optimized description\"
   voice ‚Üí \"Create social media posts to promote video\""
            ;;
        "üéµ Music Producer Workflow")
            gum style \
                --border double \
                --border-foreground 214 \
                --padding "1 2" \
                "üéµ MUSIC PRODUCER WORKFLOW

1. Creative Inspiration:
   voice ‚Üí \"Create a lofi hip-hop track for studying\"

2. Music Creation:
   voice ‚Üí \"Create new Ableton session with lofi template\"
   voice ‚Üí \"Generate chord progression in C minor\"
   voice ‚Üí \"Add vintage vinyl effects and analog warmth\"

3. Visual Design:
   voice ‚Üí \"Generate album artwork using Stable Diffusion\"
   voice ‚Üí \"Create social media graphics for release\"

4. Distribution:
   voice ‚Üí \"Export track in multiple formats\"
   voice ‚Üí \"Upload to SoundCloud with proper tags\""
            ;;
        "üë®‚Äçüíª Indie Developer Workflow")
            gum style \
                --border double \
                --border-foreground 87 \
                --padding "1 2" \
                "üë®‚Äçüíª INDIE DEVELOPER WORKFLOW

1. Market Research:
   voice ‚Üí \"Research competitor pricing and features\"
   ghsearch \"saas boilerplate\" repositories

2. Rapid Prototyping:
   voice ‚Üí \"Create Deno Fresh project with authentication\"
   voice ‚Üí \"Set up Supabase database with user tables\"

3. Design & Branding:
   voice ‚Üí \"Generate logo and brand colors\"
   voice ‚Üí \"Create landing page mockup\"

4. Deployment:
   voice ‚Üí \"Deploy app to Railway with PostgreSQL\"
   voice ‚Üí \"Set up CI/CD pipeline\""
            ;;
        "üßò Digital Minimalist Workflow")
            gum style \
                --border double \
                --border-foreground 99 \
                --padding "1 2" \
                "üßò DIGITAL MINIMALIST WORKFLOW

1. File Organization:
   voice ‚Üí \"Organize Downloads folder by type and date\"
   voice ‚Üí \"Find and remove duplicate files\"

2. Email Decluttering:
   voice ‚Üí \"Archive promotional emails from last 6 months\"
   voice ‚Üí \"Unsubscribe from unused newsletters\"

3. Desktop Optimization:
   voice ‚Üí \"Generate minimal, calming wallpaper\"
   voice ‚Üí \"Organize desktop icons\"

4. Automation:
   voice ‚Üí \"Create weekly automated backups\"
   voice ‚Üí \"Set up productivity dashboard\""
            ;;
        "üé® Creative Freelancer Workflow")
            gum style \
                --border double \
                --border-foreground 212 \
                --padding "1 2" \
                "üé® CREATIVE FREELANCER WORKFLOW

1. Client Onboarding:
   voice ‚Üí \"Create project folder structure\"
   voice ‚Üí \"Set up Notion workspace for tracking\"

2. Creative Development:
   voice ‚Üí \"Generate mood boards and concepts\"
   voice ‚Üí \"Create multiple logo variations\"
   voice ‚Üí \"Design website mockups\"

3. Client Communication:
   voice ‚Üí \"Draft professional project updates\"
   voice ‚Üí \"Create visual progress reports\"

4. Project Delivery:
   voice ‚Üí \"Package final deliverables\"
   voice ‚Üí \"Generate project case study\""
            ;;
    esac
    
    echo ""
    gum input --placeholder "Press enter to continue..."
}

show_troubleshooting() {
    ISSUE=$(gum choose \
        "üéôÔ∏è Voice Commands Not Working" \
        "üîç GitHub Search Failing" \
        "ü§ñ MCPs Not Loading" \
        "üîë API Keys Not Working" \
        "üöÄ Claude Code Issues" \
        "üîô Back")
    
    case "$ISSUE" in
        "üéôÔ∏è Voice Commands Not Working")
            gum style \
                --border double \
                --border-foreground 208 \
                --padding "1 2" \
                "üéôÔ∏è VOICE COMMANDS TROUBLESHOOTING

‚ùå Problem: Voice commands not working

‚úÖ Solutions:
1. Check OpenAI API key:
   echo \$OPENAI_API_KEY

2. Install ffmpeg:
   brew install ffmpeg

3. Check microphone permissions:
   System Preferences > Security & Privacy > Microphone
   Enable for Terminal/iTerm2

4. Test voice script exists:
   ls -la ~/voice-to-claude.sh

5. Test manually:
   ~/voice-to-claude.sh 5"
            ;;
        "üîç GitHub Search Failing")
            gum style \
                --border double \
                --border-foreground 208 \
                --padding "1 2" \
                "üîç GITHUB SEARCH TROUBLESHOOTING

‚ùå Problem: GitHub search not working

‚úÖ Solutions:
1. Check GitHub token:
   echo \$GITHUB_TOKEN

2. Authenticate GitHub CLI:
   gh auth login

3. Set GH_TOKEN:
   export GH_TOKEN=\"\$GITHUB_TOKEN\"

4. Test GitHub CLI:
   gh api user

5. Check script exists:
   ls -la ~/github-search.sh"
            ;;
        "ü§ñ MCPs Not Loading")
            gum style \
                --border double \
                --border-foreground 208 \
                --padding "1 2" \
                "ü§ñ MCPs TROUBLESHOOTING

‚ùå Problem: MCPs not loading in Claude Code

‚úÖ Solutions:
1. Restart Claude Code completely
   Quit and reopen the application

2. Check MCP configuration:
   claude mcp list

3. Check logs:
   Claude > View > Output > MCP

4. Verify API keys are set:
   env | grep -E \"(OPENAI|GOOGLE|GITHUB|SUPABASE)\"

5. Re-add problematic MCPs:
   claude mcp remove <name>
   claude mcp add <name> <command>"
            ;;
        "üîë API Keys Not Working")
            gum style \
                --border double \
                --border-foreground 208 \
                --padding "1 2" \
                "üîë API KEYS TROUBLESHOOTING

‚ùå Problem: API keys not working

‚úÖ Solutions:
1. Check keys are exported:
   echo \$OPENAI_API_KEY
   echo \$GITHUB_TOKEN

2. Reload shell:
   source ~/.zshrc

3. Test API directly:
   curl -H \"Authorization: Bearer \$OPENAI_API_KEY\" \\
        https://api.openai.com/v1/models

4. Check for typos in .zshrc:
   grep -n \"export.*API\" ~/.zshrc

5. Verify account has credits/access"
            ;;
        "üöÄ Claude Code Issues")
            gum style \
                --border double \
                --border-foreground 208 \
                --padding "1 2" \
                "üöÄ CLAUDE CODE TROUBLESHOOTING

‚ùå Problem: Claude Code not working

‚úÖ Solutions:
1. Check Claude Code is installed:
   which claude

2. Update to latest version:
   Visit: https://docs.anthropic.com/claude-code

3. Restart completely:
   Quit and reopen Claude Code

4. Check for updates:
   Claude > Check for Updates

5. Reset configuration:
   Remove ~/.claude and reconfigure"
            ;;
    esac
    
    echo ""
    gum input --placeholder "Press enter to continue..."
}

show_whats_new() {
    gum style \
        --border double \
        --border-foreground 212 \
        --padding "1 2" \
        "‚≠ê WHAT'S NEW IN YOUR AI TERMINAL

üÜï LATEST UPDATES:
‚Ä¢ Interactive MCP Help System (this menu!)
‚Ä¢ Voice-controlled terminal with Whisper API
‚Ä¢ GitHub code discovery engine
‚Ä¢ 16 AI-powered MCP servers configured
‚Ä¢ Terminal Power documentation package

üîú COMING SOON:
‚Ä¢ Wake word detection (\"Hey Claude\")
‚Ä¢ Continuous voice mode
‚Ä¢ Voice responses from Claude
‚Ä¢ Auto-repair for common issues
‚Ä¢ Cloud sync for configurations

üéØ RECENT ADDITIONS:
‚Ä¢ Rapid webapp builder with Deno + Fresh
‚Ä¢ AI-powered personal diary with voice
‚Ä¢ Creative workflow automation
‚Ä¢ One-command installer script

üí° TIP: Check the Terminal_Power folder for full documentation!"
    
    echo ""
    gum input --placeholder "Press enter to continue..."
}

show_something_cool() {
    COOL=$(gum choose \
        "ü§ñ AI Terminal Demo" \
        "üé® Generate AI Art" \
        "üéôÔ∏è Voice Command Demo" \
        "üåà Rainbow Terminal" \
        "ü¶ú Parrot Party" \
        "üéµ System Stats + Music" \
        "üîô Back")
    
    case "$COOL" in
        "ü§ñ AI Terminal Demo")
            clear
            if command -v figlet >/dev/null && command -v lolcat >/dev/null; then
                echo "CYBERPUNK AI TERMINAL" | figlet | lolcat
            fi
            echo ""
            echo "ü§ñ Your AI powers:" | lolcat
            echo "  ‚Ä¢ Voice control with Whisper API" | lolcat
            echo "  ‚Ä¢ 16 AI-powered MCPs" | lolcat  
            echo "  ‚Ä¢ GitHub code discovery" | lolcat
            echo "  ‚Ä¢ Database operations" | lolcat
            echo "  ‚Ä¢ Image generation" | lolcat
            echo "  ‚Ä¢ Email automation" | lolcat
            echo "" | lolcat
            if command -v cowsay >/dev/null; then
                echo "You are now a cyberpunk wizard! üßô‚Äç‚ôÇÔ∏è‚ö°" | cowsay | lolcat
            fi
            ;;
        "üé® Generate AI Art")
            echo "üé® AI Art Generation Demo" | figlet -f small | lolcat
            echo ""
            echo "Try these voice commands:" | lolcat
            echo "  voice ‚Üí \"generate a cyberpunk wallpaper\"" | lolcat
            echo "  voice ‚Üí \"create a logo for my startup\"" | lolcat
            echo "  voice ‚Üí \"make a minimalist desktop background\"" | lolcat
            ;;
        "üéôÔ∏è Voice Command Demo")
            echo "üéôÔ∏è Voice Control Demo" | figlet -f small | lolcat
            echo ""
            echo "Example commands to try:" | lolcat
            echo "  voice ‚Üí \"show me my database tables\"" | lolcat
            echo "  voice ‚Üí \"find react components on github\"" | lolcat
            echo "  voice ‚Üí \"create a new deno project\"" | lolcat
            echo "  voice ‚Üí \"organize my downloads folder\"" | lolcat
            ;;
        "üåà Rainbow Terminal")
            clear
            echo "üåà RAINBOW PARTY MODE! üåà" | figlet | lolcat
            if command -v fortune >/dev/null && command -v ponysay >/dev/null; then
                fortune | ponysay | lolcat
            fi
            echo ""
            echo "Your terminal is now 20% cooler! ‚ú®" | lolcat
            ;;
        "ü¶ú Parrot Party")
            echo "ü¶ú Starting Parrot Party..." | lolcat
            curl --connect-timeout 5 --max-time 15 parrot.live 2>/dev/null || echo "ü¶ú Parrot party is taking a break!" | lolcat
            ;;
        "üéµ System Stats + Music")
            clear
            if command -v neofetch >/dev/null; then
                neofetch
            fi
            echo ""
            echo "üéµ Play some music and run: cava" | lolcat
            echo "For awesome audio visualization!" | lolcat
            ;;
    esac
    
    echo ""
    gum input --placeholder "Press enter to continue..."
}

# Handle command line arguments
if [[ $# -gt 0 ]]; then
    show_main_menu "$@"
    exit 0
fi

# Start with welcome if first run
show_welcome

# Start the main menu
show_main_menu